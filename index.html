<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Fantasy City Generator</title>
    <link rel="stylesheet" type="text/css" href="static/css/site.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.1/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/v/bs5/jq-3.6.0/jszip-2.5.0/dt-1.11.3/b-2.0.1/b-colvis-2.0.1/b-html5-2.0.1/b-print-2.0.1/cr-1.5.5/fh-3.2.0/datatables.min.css" />
</head>

<!-- TODO dark mode for DataTables pagination-->

<body class="bg-dark text-light">

    <div class="container-fluid px-5" id="citygenapp">
        <p class="display-1 text-center">
            Fantasy City Generator
        </p>

        <div class="row">
            <div class="col-2" id="settings_col">
                <div class="row my-1">
                    <div class="col text-center">
                        <button class="btn btn-success btn-lg" @click="generate()"
                            :disabled="generateDisabled || isLoading">
                            <div v-if="isLoading">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                Generating...
                            </div>
                            <div v-else>
                                Generate
                            </div>
                        </button>
                        <button v-if="city.Complete && !isLoading" class="btn btn-primary btn-lg"
                            @click="downloadCSV()">
                            Download
                        </button>
                    </div>
                </div>
                <div class="row my-1">
                    <select class="form-select bg-dark text-light" v-model="citySize" @change="onSelectChanged($event)"
                        required>
                        <option value="" selected>City Size</option>
                        <option v-for="o in citySizeOptions" :value="o.name">{{ o.label() }}</option>
                    </select>
                </div>
                <div class="row my-1">
                    <select class="form-select bg-dark text-light" v-model="prosperity" required>
                        <option v-for="o in prosperityOptions" :value="o">{{ o.Label }}</option>
                    </select>
                </div>
                <div class="row my-1 border p-3 rounded" v-if="prosperity.Label == 'Custom'">
                    <div class="container">
                        <h5>Caste Percentages</h5>
                        <div class="row">
                            <label class="form-label text-light col-sm-4">Nobility</label>
                            <div class="col-sm-5">
                                <input type="range" class="custom-range" min="0" max="1" step="0.005"
                                    v-model="noblePercent" />
                            </div>
                            <div class="col-sm">{{ noblePercent * 100 }}%</div>
                        </div>
                        <div class="row">
                            <label class="form-label text-light col-sm-4">Mercantile</label>
                            <div class="col-sm-5">
                                <input type="range" class="custom-range" min="0" max="1" step="0.005"
                                    v-model="mercantilePercent" />
                            </div>
                            <div class="col-sm">{{ mercantilePercent * 100 }}%</div>
                        </div>
                        <div class="row">
                            <label class="form-label text-light col-sm-4">Tradesperson</label>
                            <div class="col-sm-5">
                                <input type="range" class="custom-range" min="0" max="1" step="0.005"
                                    v-model="tradePercent" />
                            </div>
                            <div class="col-sm">{{ tradePercent * 100 }}%</div>
                        </div>
                        <div class="row">
                            <label class="form-label text-light col-sm-4">Peasant</label>
                            <div class="col-sm-5">
                                <input type="range" class="custom-range" min="0" max="1" step="0.005"
                                    v-model="peasantPercent" />
                            </div>
                            <div class="col-sm">{{ peasantPercent * 100 }}%</div>
                        </div>
                    </div>
                </div>
                <div class="row my-1 border p-3 rounded">
                    <h5>Natural Features</h5>
                    <div class="container">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="Forest" id="forestCheck"
                                v-model="naturalFeatures">
                            <label class="form-check-label" for="forestCheck">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-tree" viewBox="0 0 16 16">
                                    <path
                                        d="M8.416.223a.5.5 0 0 0-.832 0l-3 4.5A.5.5 0 0 0 5 5.5h.098L3.076 8.735A.5.5 0 0 0 3.5 9.5h.191l-1.638 3.276a.5.5 0 0 0 .447.724H7V16h2v-2.5h4.5a.5.5 0 0 0 .447-.724L12.31 9.5h.191a.5.5 0 0 0 .424-.765L10.902 5.5H11a.5.5 0 0 0 .416-.777l-3-4.5zM6.437 4.758A.5.5 0 0 0 6 4.5h-.066L8 1.401 10.066 4.5H10a.5.5 0 0 0-.424.765L11.598 8.5H11.5a.5.5 0 0 0-.447.724L12.69 12.5H3.309l1.638-3.276A.5.5 0 0 0 4.5 8.5h-.098l2.022-3.235a.5.5 0 0 0 .013-.507z" />
                                </svg> Forest
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="Mountains/Hills" id="mountainCheck"
                                v-model="naturalFeatures">
                            <label class="form-check-label" for="mountainCheck">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-minecart" viewBox="0 0 16 16">
                                    <path
                                        d="M4 15a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm0 1a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm8-1a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm0 1a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM.115 3.18A.5.5 0 0 1 .5 3h15a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 14 12H2a.5.5 0 0 1-.491-.408l-1.5-8a.5.5 0 0 1 .106-.411zm.987.82 1.313 7h11.17l1.313-7H1.102z" />
                                </svg> Mountains/Hills
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="Ocean" id="oceanCheck"
                                v-model="naturalFeatures">
                            <label class="form-check-label" for="oceanCheck">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-tsunami" viewBox="0 0 16 16">
                                    <path
                                        d="M.036 12.314a.5.5 0 0 1 .65-.278l1.757.703a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.757-.703a.5.5 0 1 1 .372.928l-1.758.703a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.757-.703a.5.5 0 0 1-.278-.65zm0 2a.5.5 0 0 1 .65-.278l1.757.703a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.757-.703a.5.5 0 1 1 .372.928l-1.758.703a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.757-.703a.5.5 0 0 1-.278-.65zM2.662 8.08c-.456 1.063-.994 2.098-1.842 2.804a.5.5 0 0 1-.64-.768c.652-.544 1.114-1.384 1.564-2.43.14-.328.281-.68.427-1.044.302-.754.624-1.559 1.01-2.308C3.763 3.2 4.528 2.105 5.7 1.299 6.877.49 8.418 0 10.5 0c1.463 0 2.511.4 3.179 1.058.67.66.893 1.518.819 2.302-.074.771-.441 1.516-1.02 1.965a1.878 1.878 0 0 1-1.904.27c-.65.642-.907 1.679-.71 2.614C11.076 9.215 11.784 10 13 10h2.5a.5.5 0 0 1 0 1H13c-1.784 0-2.826-1.215-3.114-2.585-.232-1.1.005-2.373.758-3.284L10.5 5.06l-.777.388a.5.5 0 0 1-.447 0l-1-.5a.5.5 0 0 1 .447-.894l.777.388.776-.388a.5.5 0 0 1 .447 0l1 .5a.493.493 0 0 1 .034.018c.44.264.81.195 1.108-.036.328-.255.586-.729.637-1.27.05-.529-.1-1.076-.525-1.495-.426-.42-1.19-.77-2.477-.77-1.918 0-3.252.448-4.232 1.123C5.283 2.8 4.61 3.738 4.07 4.79c-.365.71-.655 1.433-.945 2.16-.15.376-.301.753-.463 1.13z" />
                                </svg> Ocean
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="Lake" id="lakeCheck"
                                v-model="naturalFeatures">
                            <label class="form-check-label" for="lakeCheck">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-water" viewBox="0 0 16 16">
                                    <path
                                        d="M.036 3.314a.5.5 0 0 1 .65-.278l1.757.703a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.757-.703a.5.5 0 1 1 .372.928l-1.758.703a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0L.314 3.964a.5.5 0 0 1-.278-.65zm0 3a.5.5 0 0 1 .65-.278l1.757.703a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.757-.703a.5.5 0 1 1 .372.928l-1.758.703a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0L.314 6.964a.5.5 0 0 1-.278-.65zm0 3a.5.5 0 0 1 .65-.278l1.757.703a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.757-.703a.5.5 0 1 1 .372.928l-1.758.703a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0L.314 9.964a.5.5 0 0 1-.278-.65zm0 3a.5.5 0 0 1 .65-.278l1.757.703a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.014-.406a2.5 2.5 0 0 1 1.857 0l1.015.406a1.5 1.5 0 0 0 1.114 0l1.757-.703a.5.5 0 1 1 .372.928l-1.758.703a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.014-.406a1.5 1.5 0 0 0-1.114 0l-1.015.406a2.5 2.5 0 0 1-1.857 0l-1.757-.703a.5.5 0 0 1-.278-.65z" />
                                </svg> Lake
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="River" id="riverCheck"
                                v-model="naturalFeatures">
                            <label class="form-check-label" for="riverCheck">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                    class="bi bi-droplet" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M7.21.8C7.69.295 8 0 8 0c.109.363.234.708.371 1.038.812 1.946 2.073 3.35 3.197 4.6C12.878 7.096 14 8.345 14 10a6 6 0 0 1-12 0C2 6.668 5.58 2.517 7.21.8zm.413 1.021A31.25 31.25 0 0 0 5.794 3.99c-.726.95-1.436 2.008-1.96 3.07C3.304 8.133 3 9.138 3 10a5 5 0 0 0 10 0c0-1.201-.796-2.157-2.181-3.7l-.03-.032C9.75 5.11 8.5 3.72 7.623 1.82z" />
                                    <path fill-rule="evenodd"
                                        d="M4.553 7.776c.82-1.641 1.717-2.753 2.093-3.13l.708.708c-.29.29-1.128 1.311-1.907 2.87l-.894-.448z" />
                                </svg> River
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row my-1 border p-3 rounded">
                    <div class="container">
                        <h5>Race Frequency</h5>
                        <h6><small class="text-muted">Some default values are already selected.</small></h6>
                        <h6 class="text-danger" v-if="raceError">{{raceError}}</h6>
                        <table class="table">
                            <tr v-for="r in raceOptions">
                                <td>
                                    <label class="form-label text-light">{{r}}</label>
                                </td>
                                <td>
                                    <select class="form-select bg-dark text-light" :id="r.replace(' ','')"
                                        v-model="raceFreqSettings[r]" :class="frequencyClass[raceFreqSettings[r]]"
                                        @change="$forceUpdate()">
                                        <option value="">None</option>
                                        <option v-for="o in raceFreqOptions" :value="o" :class="frequencyClass[o]">{{ o
                                            }}
                                        </option>
                                    </select>
                                </td>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-10">
                <div v-if="isLoading">
                    <div class="progress-bar" role="progressbar"
                        :style="`width: ${ !citygen ? 1 : Math.floor(100 * city.People.length/citygen.TotalPopSize)}%`">
                    </div>
                </div>
                <div :style="isLoading ? 'display:none' : ''">
                    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="about-tab" data-bs-toggle="tab" data-bs-target="#about"
                                type="button" role="tab">About</button>
                        </li>
                        <li v-if="city.Complete" class="nav-item" role="presentation">
                            <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail"
                                type="button" role="tab">Details</button>
                        </li>
                        <li v-if="city.Complete" class="nav-item" role="presentation">
                            <button class="nav-link" id="people-tab" data-bs-toggle="tab" data-bs-target="#people"
                                type="button" role="tab">People</button>
                        </li>
                        <li v-if="city.Complete" class="nav-item" role="presentation">
                            <button class="nav-link" id="business-tab" data-bs-toggle="tab" data-bs-target="#business"
                                type="button" role="tab">Businesses</button>
                        </li>
                        <li v-if="city.Complete" class="nav-item" role="presentation">
                            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory"
                                type="button" role="tab">Inventories</button>
                        </li>
                        <li v-if="city.Complete" class="nav-item" role="presentation">
                            <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats"
                                type="button" role="tab">Stats</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="changes-tab" data-bs-toggle="tab" data-bs-target="#changes"
                                type="button" role="tab">Change Log</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3 border-start border-end border-bottom" id="resultTabContent">
                        <div class="tab-pane fade show active" id="about" role="tabpanel">
                            <h5>
                                Instructions
                            </h5>
                            <ol>
                                <li>Set the city size.</li>
                                <li>(Optional) Set the prosperity.</li>
                                <li>(Optional) Add natural features.</li>
                                <li>(Optional) Adjust how often races appear.</li>
                                <li>Click Generate!</li>
                            </ol>
                            <p>
                                <a href="https://paypal.me/praxxian?locale.x=en_US" target="_blank"
                                    rel="noopener noreferrer">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-dice-6" viewBox="0 0 16 16">
                                        <path
                                            d="M13 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h10zM3 0a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V3a3 3 0 0 0-3-3H3z" />
                                        <path
                                            d="M5.5 4a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm8 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-4a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm-8 4a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-4a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
                                    </svg>
                                    If you're feeling generous, buy me some dice.
                                </a>
                            </p>
                            <p>
                                <a href="https://github.com/Praxxian/RPG-City-Generator/issues/new" target="_blank"
                                    rel="noopener noreferrer">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-exclamation-triangle" viewBox="0 0 16 16">
                                        <path
                                            d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.146.146 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.163.163 0 0 1-.054.06.116.116 0 0 1-.066.017H1.146a.115.115 0 0 1-.066-.017.163.163 0 0 1-.054-.06.176.176 0 0 1 .002-.183L7.884 2.073a.147.147 0 0 1 .054-.057zm1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z" />
                                        <path
                                            d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995z" />
                                    </svg> Report an issue</a>
                            </p>
                            <hr>
                            <h5>
                                Description
                            </h5>
                            <p>
                                I created this free tool to create a village, town, or city population with enough NPCs
                                to make the populations realistic for a medieval setting.
                            </p>
                            <h5>
                                Features
                            </h5>
                            <ul>
                                <li>Hundreds to thousands of NPCs created with names, families, jobs, personalities, and
                                    appearances.</li>
                                <li>Downloadable to CSV.</li>
                                <ul>
                                    <li>Even more details about NPCs are available in the CSV.</li>
                                </ul>
                                <li>Select how common/uncommon/rare each race is.</li>
                                <li>Businesses with distinct names and inventories.</li>
                                <ul>
                                    <li>Depending on the business, some items are always available, while others have a
                                        random chance of appearing. Not every smith has plate barding!</li>
                                    <li>Inventory items come mostly from the source books, but have been expanded to
                                        include jewels and other trinkets players might need for spell components.</li>
                                    <li>Some businesses are only available in Towns and Cities. Small villages may not
                                        have all the creature comforts.</li>
                                    <li>Some businesses offer services from the DMG like skilled/unskilled labor, coach
                                        cabs, and messengers.</li>
                                    <li>Taverns/Inns include pricing for all costs of living so you can choose the
                                        quality.</li>
                                </ul>
                                <li>Town descriptions based on roll tables from the DMG.</li>
                                <ul>
                                    <li>Presently these are just for flavor and do not translate to the NPCs generated.
                                    </li>
                                </ul>
                                <!-- <li>Schedules for each NPC so you can see who is at the pub or store when the PCs enter. -->
                                </li>
                                <li>Age distributions that make sense for medieval settings. It's not equal parts
                                    children, adults, and elderly.</li>
                                <li>Populations divided by caste that make sense. (Awful lotta farms...)</li>
                                <li>Ages adjusted for the NPC race.</li>
                            </ul>
                            <h5>
                                Uses
                            </h5>
                            <ul>
                                <li>Create new towns from scratch and edit it to fit your setting.</li>
                                <li>Supplement towns from existing adventures.</li>
                            </ul>
                            <p>
                                That last one comes in handy! Want to add a smith and wainwright to The Village of
                                Barovia in <em>Curse of Strahd</em>? Just copy them, their family, and their inventories
                                to your
                                notes. You don't need to bring the whole generated village along if you don't want!
                            </p>
                        </div>
                        <div v-if="city.Complete" class="tab-pane fade" id="detail" role="tabpanel">
                            <p>
                                This {{ city.Settings.CitySize.name }} (population
                                {{ city.People.length.toLocaleString() }}) features
                                <strong>{{ city.Details.notableTrait }}</strong> and is known for its
                                <strong>{{ city.Details.knownFor }}</strong>. Unfortunately, it is afflicted by
                                <strong>{{ city.Details.calamity }}</strong>.
                            </p>
                        </div>
                        <div class="tab-pane fade" id="people" role="tabpanel">
                            <table
                                class="table result-table table-striped table-hover table-bordered table-sm table-dark nowrap"
                                id="people_table" style="width: 100%;">
                                <thead>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Race</th>
                                    <th>Caste</th>
                                    <th>Age</th>
                                    <th>Gender</th>
                                    <th>Spouse</th>
                                    <th>Family</th>
                                    <th>Works At</th>
                                    <!-- <th>Personality</th> -->
                                    <th>Appearance</th>
                                    <th>Strength</th>
                                    <th>Weakness</th>
                                    <th>Talent</th>
                                    <th>Mannerism</th>
                                    <th>Interaction</th>
                                </thead>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="business" role="tabpanel">
                            <h3>Shops</h3>
                            <table
                                class="table result-table table-striped table-hover table-bordered table-sm table-dark"
                                id="business_table" style="width: 100%;">
                                <thead>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Owners</th>
                                    <th>Employees</th>
                                    <th>Description</th>
                                </thead>
                            </table>
                            <hr>
                            <h3>Estates</h3>
                            <table
                                class="table result-table table-striped table-hover table-bordered table-sm table-dark"
                                id="estate_table" style="width: 100%;">
                                <thead>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Owners</th>
                                    <th>Employees</th>
                                </thead>
                            </table>
                            <hr>
                            <h3>Farms</h3>
                            <table
                                class="table result-table table-striped table-hover table-bordered table-sm table-dark"
                                id="farm_table" style="width: 100%;">
                                <thead>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Owners</th>
                                    <th>Employees</th>
                                </thead>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="inventory" role="tabpanel">
                            <table
                                class="table result-table table-striped table-hover table-bordered table-sm table-dark nowrap"
                                id="inventory_table" style="width: 100%;">
                                <thead>
                                    <th>Business</th>
                                    <th>Item</th>
                                    <th>Cost</th>
                                </thead>
                            </table>
                        </div>
                        <div class="tab-pane fade" id="stats" role="tabpanel">
                            <h5>Race Distributions</h5>
                            <canvas id="race_graph" width="400" height="100"></canvas>
                            <h5>Age Distributions</h5>
                            <canvas id="age_graph" width="400" height="100"></canvas>
                        </div>
                        <div class="tab-pane fade" id="changes" role="tabpanel">
                            <div v-for="change in changes">
                                <h5>{{change.Date}}</h5>
                                <ul class="ml-3">
                                    <li v-for="c in change.Changes">{{ c }}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.1/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script type="text/javascript"
        src="https://cdn.datatables.net/v/bs5/jq-3.6.0/jszip-2.5.0/dt-1.11.3/b-2.0.1/b-colvis-2.0.1/b-html5-2.0.1/b-print-2.0.1/cr-1.5.5/fh-3.2.0/datatables.min.js"></script>
    <!-- TODO swap for prod version -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script src="static/js/changelog.js"></script>
    <script src="static/js/stats.js"></script>
    <script src="static/js/enums.js"></script>
    <script src="static/js/names.js"></script>
    <script src="static/js/models.js"></script>
    <script src="static/js/namegen.js"></script>
    <script src="static/js/citygen.js"></script>
    <script>
        function doubleRaf(callback) {
            requestAnimationFrame(() => {
                requestAnimationFrame(callback)
            })
        }

        var dice = `<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-dice-6" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M13 1H3a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zM3 0a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V3a3 3 0 0 0-3-3H3z"/>
  <circle cx="4" cy="4" r="1.5"/>
  <circle cx="12" cy="4" r="1.5"/>
  <circle cx="12" cy="12" r="1.5"/>
  <circle cx="12" cy="8" r="1.5"/>
  <circle cx="4" cy="12" r="1.5"/>
  <circle cx="4" cy="8" r="1.5"/>
</svg>`;

        Vue.component('reroll-btn', {
            props: ['id', 'entity'],
            template: `<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-dice-6" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path fill-rule="evenodd" d="M13 1H3a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zM3 0a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V3a3 3 0 0 0-3-3H3z"/>
  <circle cx="4" cy="4" r="1.5"/>
  <circle cx="12" cy="4" r="1.5"/>
  <circle cx="12" cy="12" r="1.5"/>
  <circle cx="12" cy="8" r="1.5"/>
  <circle cx="4" cy="12" r="1.5"/>
  <circle cx="4" cy="8" r="1.5"/>
</svg>`
        });

        var prosperityOptions = [
            { Label: "Average Prosperity", noblePercent: 0.005, mercantilePercent: 0.015, tradePercent: 0.18, peasantPercent: 0.80 },
            { Label: "Destitute", noblePercent: 0.0025, mercantilePercent: 0.0075, tradePercent: 0.09, peasantPercent: 0.90 },
            { Label: "Prosperous", noblePercent: 0.01, mercantilePercent: 0.03, tradePercent: 0.36, peasantPercent: 0.60 },
            { Label: "Custom", noblePercent: 0.005, mercantilePercent: 0.015, tradePercent: 0.18, peasantPercent: 0.80 },
        ];

        var citygenapp = new Vue({
            el: '#citygenapp',
            data: {
                generateDisabled: true,
                citySizeOptions: CitySize,
                raceOptions: Race,
                raceFreqOptions: RaceFrequency,
                defaultRaceSettings: [
                    { race: Race.HUMAN, frequency: RaceFrequency.COMMON },
                    { race: Race.HALF_ELF, frequency: RaceFrequency.UNCOMMON },
                    { race: Race.DWARF, frequency: RaceFrequency.UNCOMMON },
                    { race: Race.ELF, frequency: RaceFrequency.RARE },
                    { race: Race.GNOME, frequency: RaceFrequency.RARE }],
                citySize: '',
                gen_name_range: 0,
                city: new City(),
                citygen: null,
                isLoading: false,
                raceFreqSettings: {},
                stage: '',
                frequencyClass: {
                    Common: 'text-success',
                    Uncommon: 'text-warning',
                    Rare: 'text-danger',
                },
                prosperityOptions: prosperityOptions,
                prosperity: prosperityOptions[0],
                noblePercent: -1,
                mercantilePercent: -1,
                tradePercent: -1,
                peasantPercent: -1,
                naturalFeatures: [],
                naturalFeaturesOptions: NaturalFeatures,
                raceError: null,
                changes: CHANGES
            },
            mounted: function () {
                for (var i in this.raceOptions) {
                    var race = this.raceOptions[i];
                    var defaultSetting = this.defaultRaceSettings.filter(y => y.race == race)[0];
                    var freq = defaultSetting ? defaultSetting.frequency : '';
                    this.raceFreqSettings[race] = freq;
                }
                this.$forceUpdate();
            },
            updated: function () {
                // TODO handle invalid race settings and missing race settings

                this.updateProsperity();
            },
            computed: {
            },
            methods: {
                onSelectChanged(event) {
                    if (this.citySize)
                        this.generateDisabled = false;
                },
                generate() {
                    this.isLoading = true;
                    doubleRaf(() => this.generateAsync());
                },
                async generateAsync() {
                    try {
                        if (!this.validateSettings())
                            return;
                        console.log('Generating City...');
                        $('.result-table').DataTable().destroy();
                        var settings = {
                            CitySize: this.citySize,
                            Races: this.raceFreqSettings,
                            NaturalFeatures: this.naturalFeatures,
                            Prosperity: this.prosperity
                        }
                        this.citygen = new CityGenerator(settings);
                        this.city = await this.citygen.getNew();
                        this.initDataTables();
                        this.updateCharts();
                        console.log('Generating City complete.');
                    }
                    catch (e) {
                        console.log(e);
                    }
                    finally {
                        this.isLoading = false;
                    }
                },
                validateSettings() {
                    this.raceError = "You must select at least one common race.";
                    for (key in this.raceFreqSettings) {
                        if (this.raceFreqSettings[key] == RaceFrequency.COMMON) {
                            this.raceError = null;
                            break;
                        }
                    }
                    return this.raceError == null;
                },
                toggleSettings(event) {
                    $('#settings_col').collapse('toggle');
                    var button = $('#collapse-btn');
                    if (button.html() == '«')
                        button.html("Settings<br/>»");
                    else
                        button.html("«");
                },
                initDataTables() {
                    console.log('Initiating DataTables...');
                    if ($('.result-table').DataTable())
                        $('.result-table').DataTable().destroy();

                    var peopleArr = [];
                    var bizArray = [];
                    var farmArray = [];
                    var estateArray = [];
                    var inventoryArray = [];

                    if (this.city) {
                        console.log('Setting table data...');
                        peopleArr = this.city.People.map(x => [
                            x.Id,
                            `${x.fullName()}`,
                            x.Race,
                            x.Caste,
                            x.RaceAge,
                            x.Gender,
                            x.Spouse ?? '',
                            x.Family.displayValue(),
                            x.getBusiness() ? `${x.getBusiness()} (Owner)` : x.getEmployer() ?? '',
                            //x.Personality.toLabel(),
                            x.Appearance ?? '',
                            x.Strength ?? '',
                            x.Weakness ?? '',
                            x.Talent ?? '',
                            x.Mannerism ?? '',
                            x.Interaction ?? '',
                        ]);

                        bizArray = this.city.Businesses.filter(x => x.BusinessType != BusinessType.FARM && x.BusinessType != BusinessType.ESTATE).map(x => ({
                            Name: x.Name,
                            BusinessType: x.BusinessType.name,
                            Owners: x.Owners.map(o => o.fullName()).join(', '),
                            Employees: (x.Employees.length > 10 ? x.Employees.slice(0, 10) : x.Employees).map(o => o.fullName()).join(', ') + (x.Employees.length > 10 ? "... (" + x.Employees.length + " total)" : ""),
                            Description: x.Description ?? '',
                        }));

                        farmArray = this.city.Businesses.filter(x => x.BusinessType == BusinessType.FARM).map(x => ({
                            Name: x.Name,
                            BusinessType: x.BusinessType.name,
                            Owners: x.Owners.map(o => o.fullName()).join(', '),
                            Employees: x.Employees.map(o => o.fullName()).join(', '),
                        }));

                        estateArray = this.city.Businesses.filter(x => x.BusinessType == BusinessType.ESTATE).map(x => ({
                            Name: x.Name,
                            BusinessType: x.BusinessType.name,
                            Owners: x.Owners.map(o => o.fullName()).join(', '),
                            Employees: x.Employees.map(o => o.fullName()).join(', '),
                        }));

                        for (var i = 0; i < this.city.Businesses.length; i++) {
                            var biz = this.city.Businesses[i];
                            if (biz.BusinessType == BusinessType.FARM)
                                continue;
                            for (var j = 0; j < biz.Inventory.length; j++) {
                                var item = biz.Inventory[j];
                                inventoryArray.push([
                                    biz.Name,
                                    item.Name,
                                    item.displayCost()
                                ])
                            }
                        }

                        console.log('Setting table data complete.');
                    }

                    var dtDOM = '<"row"<"col-sm-4"l><"col-sm-4"B><"col-sm-4"f>><"row"<"col"i><"col"p>>rt<"row"<"col"i><"col"p>>';
                    var dtDOMSmall = '<"row"<"col-sm-4"l><"col-sm-4"B><"col-sm-4"f>>rt<"row"<"col"i><"col"p>>';
                    var dtButtons = ['copy', 'excel', 'csv'];

                    var peopleTable = $('#people_table').DataTable({
                        "pageLength": 100,
                        'processing': true,
                        "scrollX": true,
                        autoWidth: true,
                        "fnInitComplete": function (oSettings) {
                            $(window).resize();
                        },
                        "fnDrawCallback": function (oSettings) {
                            $(window).trigger('resize');
                        },
                        data: peopleArr,
                        dom: dtDOM,
                        buttons: dtButtons,
                        colReorder: true
                    });

                    var bizTable = $('#business_table').DataTable({
                        "pageLength": 10,
                        'processing': true,
                        "scrollX": true,
                        data: bizArray,
                        columns: [
                            { data: 'Name' },
                            { data: 'BusinessType' },
                            { data: 'Owners' },
                            { data: 'Employees' },
                            { data: 'Description' },
                        ],
                        dom: dtDOMSmall,
                        buttons: dtButtons,
                        colReorder: true
                    });

                    var farmTable = $('#farm_table').DataTable({
                        "pageLength": 10,
                        'processing': true,
                        "scrollX": true,
                        data: farmArray,
                        columns: [
                            { data: 'Name' },
                            { data: 'BusinessType' },
                            { data: 'Owners' },
                            { data: 'Employees' },
                        ],
                        dom: dtDOMSmall,
                        buttons: dtButtons,
                        colReorder: true
                    });

                    var estateTable = $('#estate_table').DataTable({
                        "pageLength": 10,
                        'processing': true,
                        "scrollX": true,
                        data: estateArray,
                        columns: [
                            { data: 'Name' },
                            { data: 'BusinessType' },
                            { data: 'Owners' },
                            { data: 'Employees' },
                        ],
                        dom: dtDOMSmall,
                        buttons: dtButtons,
                        colReorder: true
                    });

                    var inventoryTable = $('#inventory_table').DataTable({
                        "pageLength": 100,
                        'processing': true,
                        "scrollX": true,
                        data: inventoryArray,
                        dom: dtDOM,
                        buttons: dtButtons,
                        colReorder: true
                    });
                    this.$forceUpdate();
                    console.log('Initiating DataTables complete.');
                },
                updateCharts() {
                    var ctxAge = document.getElementById('age_graph').getContext('2d');
                    var ageData = [
                        this.city.People.filter(x => x.Age <= 10).length,
                        this.city.People.filter(x => x.Age > 10 && x.Age <= 20).length,
                        this.city.People.filter(x => x.Age > 20 && x.Age <= 30).length,
                        this.city.People.filter(x => x.Age > 30 && x.Age <= 40).length,
                        this.city.People.filter(x => x.Age > 40 && x.Age <= 50).length,
                        this.city.People.filter(x => x.Age > 50 && x.Age <= 60).length,
                        this.city.People.filter(x => x.Age > 60 && x.Age <= 70).length,
                        this.city.People.filter(x => x.Age > 70 && x.Age <= 80).length,
                        this.city.People.filter(x => x.Age > 80 && x.Age <= 90).length,
                        this.city.People.filter(x => x.Age > 90 && x.Age <= 100).length,
                    ];
                    var options = {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    };
                    var ageChart = new Chart(ctxAge, {
                        type: 'line',
                        data: {
                            labels: ['0-10', '11-20', '21-30', '31-40', '41-50', '51-60', '61-70', '71-80', '81-90', '91-100'],
                            datasets: [{
                                label: 'Age Count',
                                data: ageData,
                                borderWidth: 1
                            }]
                        },
                        options: options
                    });

                    var raceLabels = [];
                    for (var i in this.raceFreqSettings) {
                        if (this.raceFreqSettings[i])
                            raceLabels.push(i);
                    }
                    var raceData = [];
                    var raceColors = [];
                    for (var i = 0; i < raceLabels.length; i++) {
                        raceData.push(this.city.People.filter(x => x.Race == raceLabels[i]).length);

                        var r = CryptoRandom.random() * 159 + 32;
                        var g = CryptoRandom.random() * 159 + 32;
                        var b = CryptoRandom.random() * 159 + 32;
                        raceColors.push(`rgb(${r}, ${g}, ${b})`);
                    }

                    var ctxRace = document.getElementById('race_graph').getContext('2d');
                    var raceChart = new Chart(ctxRace, {
                        type: 'doughnut',
                        data: {
                            labels: raceLabels,
                            datasets: [{
                                label: 'Race Count',
                                data: raceData,
                                backgroundColor: raceColors
                                //borderWidth: 1
                            }]
                        }
                    });
                },
                getFrequencyClass(race) {
                    var f = this.raceFreqSettings[race];
                    if (f)
                        return this.frequencyClass[f];
                    else
                        return '';
                },
                downloadCSV() {
                    var rows = [
                        ['Each set of data will be proceeded by a header in square brackets: [].'],
                        [''],
                        ['[DESCRIPTION]'],
                        Object.keys(this.city.Details),
                        Object.values(this.city.Details),
                        [''],
                        ['[PEOPLE]'],
                        Object.keys(this.city.People[0]),
                    ];

                    for (var i = 0; i < this.city.People.length; i++) {
                        rows.push(Object.values(this.city.People[i]).map(x => this.csvClean(x)));
                    }

                    rows.push(['']);
                    rows.push(['[BUSINESSES]'])
                    rows.push(Object.keys(this.city.Businesses[0]));
                    for (var i = 0; i < this.city.Businesses.length; i++) {
                        rows.push(Object.values(this.city.Businesses[i]).map(x => this.csvClean(x)));
                    }

                    rows.push(['']);
                    rows.push(['[INVENTORY]'])
                    var invHeaders = ['Business', 'Item', 'Cost'].map(x => this.csvClean(x));
                    rows.push(invHeaders);
                    for (var i = 0; i < this.city.Businesses.length; i++) {
                        for (var j = 0; j < this.city.Businesses[i].Inventory.length; j++) {
                            var item = this.city.Businesses[i].Inventory[j];
                            var invData = [this.city.Businesses[i].Name, item.Name, item.displayCost()].map(x => this.csvClean(x));
                            rows.push(invData);
                        }
                    }

                    let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");

                    var encodedUri = encodeURI(csvContent);
                    var link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "rpg_city.csv");
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                },
                csvClean(value) {
                    if (Array.isArray(value))
                        value = value.join('; ');
                    return '"' + (value ?? '') + '"';
                },
                updateProsperity() {
                    if (this.prosperity.Label == "Custom") {
                        var total = 1.0;

                        this.noblePercent = Math.min(total, this.noblePercent).toPrecision(3);
                        this.prosperity.noblePercent = this.noblePercent;
                        total = Math.max(0, total - this.prosperity.noblePercent);

                        this.mercantilePercent = Math.min(total, this.mercantilePercent).toPrecision(3);
                        this.prosperity.mercantilePercent = this.mercantilePercent;
                        total = Math.max(0, total - this.prosperity.mercantilePercent);

                        this.tradePercent = Math.min(total, this.tradePercent).toPrecision(3);
                        this.prosperity.tradePercent = this.tradePercent
                        total = Math.max(0, total - this.prosperity.tradePercent);

                        this.peasantPercent = total.toPrecision(3)
                        this.prosperity.peasantPercent = this.peasantPercent;
                    }
                    else {
                        this.noblePercent = this.prosperity.noblePercent;
                        this.mercantilePercent = this.prosperity.mercantilePercent;
                        this.tradePercent = this.prosperity.tradePercent;
                        this.peasantPercent = this.prosperity.peasantPercent;
                    }
                }
            }
        });

        $(document).on('shown.bs.tab', 'button[data-bs-toggle="tab"]', function (e) {
            $('.result-table').DataTable().columns.adjust();
        })
    </script>
</body>

</html>